#!/bin/bash
# User synchronization script - Generated by Ansible
# Based on update_users.sh from vsftpd_container
set -euo pipefail

CONFIG_PATH="{{ user_config_file }}"
GROUP="{{ ftp_user_group }}"
BASE_DIR="{{ ftp_base_dir }}"

echo "[INFO] Updating users from: $CONFIG_PATH"

if [[ -f "$CONFIG_PATH" ]]; then
  echo "[INFO] User config found at $CONFIG_PATH. Bootstrapping users..."
  for user in $(jq -r 'keys[]' "$CONFIG_PATH"); do
    hash=$(jq -r --arg u "$user" '.[$u]' "$CONFIG_PATH")

    if ! id "$user" &>/dev/null; then
      echo "[INFO] Creating user: $user"
      useradd -m -d $BASE_DIR/$user -s {{ user_shell }} -g $GROUP "$user"

    else
      echo "[INFO] User $user already exists."
    fi

    sed -i "s|^$user:[^:]*:|$user:$hash:|" /etc/shadow

    echo "[INFO] User $user created with home directory $BASE_DIR/$user."

    # Set root folder permissions to be unwritable by user
    chown root:root $BASE_DIR/$user
    chmod 755 $BASE_DIR/$user

    # Create user in/out folders in Directory if they do not exist
{% for dir in user_subdirectories %}
    if [[ ! -d $BASE_DIR/$user/{{ dir }} ]]; then
      mkdir -p $BASE_DIR/$user/{{ dir }}
      chown "$user" $BASE_DIR/$user/{{ dir }}
      chmod 700 $BASE_DIR/$user/{{ dir }}
      echo "[INFO] Created {{ dir }} directory for user $user."
    else
      echo "[INFO] {{ dir }} directory for user $user already exists."
    fi
{% endfor %}
  done
else
  echo "[WARN] No user JSON found at $CONFIG_PATH â€” skipping user bootstrap."
fi
